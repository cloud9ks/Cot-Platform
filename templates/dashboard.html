<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COT Analysis Platform · Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --primary:#2563eb; --secondary:#10b981; --danger:#ef4444; --warning:#f59e0b;
      --dark:#0f172a; --muted:#64748b; --light:#f8fafc; --card-bg:#ffffff; --success:#10b981;
    }
    *{box-sizing:border-box}
    body{
      background:radial-gradient(1200px 600px at 10% -10%, #93c5fd33, transparent),
                 radial-gradient(1000px 500px at 110% 10%, #c084fc33, transparent),
                 linear-gradient(135deg, #e2e8f0, #f8fafc);
      font-family:Inter, system-ui, -apple-system, sans-serif; min-height:100vh; color:#0f172a;
    }
    .dashboard-container{background:rgba(255,255,255,.95); backdrop-filter:saturate(1.2) blur(12px);
      border-radius:20px; margin:24px auto; padding:28px; box-shadow:0 20px 60px rgba(2,6,23,.12); max-width:1600px;}
    .card-enhanced{background:var(--card-bg); border-radius:16px; padding:20px;
      box-shadow:0 4px 20px rgba(2,6,23,.08); border:1px solid rgba(2,6,23,.06);
      transition:transform .25s ease, box-shadow .25s ease; height:100%;}
    .card-enhanced:hover{transform:translateY(-4px); box-shadow:0 12px 40px rgba(2,6,23,.15);}
    .symbol-selector{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;}
    .symbol-btn{padding:12px 20px; border:2px solid var(--primary); background:#fff; color:var(--primary);
      border-radius:12px; cursor:pointer; transition:all .2s ease; font-weight:700; letter-spacing:.3px; position:relative; overflow:hidden;}
    .symbol-btn:hover{background:var(--primary); color:#fff; transform:translateY(-2px); box-shadow:0 6px 20px rgba(37,99,235,.3);}
    .symbol-btn.active{background:var(--primary); color:#fff;}
    .badge.bg-purple{background:linear-gradient(135deg,#667eea,#764ba2)!important; color:#fff; padding:10px 20px; border-radius:50px; font-weight:600;}
    .signal-box{display:inline-block; padding:8px 16px; border-radius:999px; font-weight:700; font-size:13px; letter-spacing:.3px; text-transform:uppercase;}
    .signal-bullish{background:linear-gradient(135deg,#10b981,#34d399); color:#fff;}
    .signal-bearish{background:linear-gradient(135deg,#ef4444,#f87171); color:#fff;}
    .signal-neutral{background:linear-gradient(135deg,#6b7280,#9ca3af); color:#fff;}
    .chart-card{background:var(--card-bg); border-radius:16px; padding:20px; box-shadow:0 4px 20px rgba(2,6,23,.08); border:1px solid rgba(2,6,23,.06);}
    .chart-wrap{position:relative; height:400px;}
    .live-indicator{width:10px; height:10px; display:inline-block; background:#10b981; border-radius:50%; box-shadow:0 0 0 0 rgba(16,185,129,.7); animation:pulse 2s infinite; margin-right:6px;}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.6)} 70%{box-shadow:0 0 0 8px rgba(16,185,129,0)} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}
    .nav-tabs-custom .nav-link{border-radius:12px 12px 0 0; border:none; background:rgba(255,255,255,.7); margin-right:4px; transition:all .3s ease;}
    .nav-tabs-custom .nav-link.active{background:var(--primary); color:white;}
    .loading{text-align:center; padding:40px; color:var(--muted);}
    @media (max-width:768px){.dashboard-container{margin:12px; padding:16px;} .symbol-btn{padding:8px 12px; font-size:12px;}}
    
    #gptAnalysis .gpt-premium {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 30px;
      color: white;
      box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="mb-1 fw-bold">
          <i class="fa-solid fa-chart-line text-primary me-2"></i>
          COT Analysis Platform
        </h1>
        <p class="text-muted mb-0">
          <span class="live-indicator"></span>
          Analisi Professionale dei Dati COT con AI
          <span class="badge bg-success ms-1">Sistema Online</span>
        </p>
      </div>
      
      <div class="d-flex gap-2 align-items-center">
        <!-- Badge Admin -->
        {% if current_user.is_authenticated and current_user.is_admin %}
        <span class="badge bg-purple">
          <i class="fa-solid fa-crown"></i> ADMIN
        </span>
        {% endif %}
        
        <!-- Link Profilo -->
        <a href="/profile" class="btn btn-outline-secondary">
          <i class="fa-solid fa-user"></i> Profilo
        </a>
        
        <!-- Pulsanti Admin -->
        {% if current_user.is_authenticated and current_user.is_admin %}
        <button class="btn btn-outline-primary" id="btnRefresh">
          <i class="fa-solid fa-rotate-right"></i> Aggiorna
        </button>
        <button class="btn btn-success" id="btnRun">
          <i class="fa-solid fa-brain"></i> Analisi AI
        </button>
        {% else %}
        <span class="badge bg-success" style="padding:10px 16px;">
          <i class="fa-solid fa-clock-rotate-left"></i>
          Auto-aggiornamento attivo
        </span>
        {% endif %}
      </div>
    </div>

    <!-- INFO PIANO -->
    <div class="alert alert-info d-flex align-items-center justify-content-between mb-4">
      <div class="d-flex align-items-center gap-3">
        <i class="fa-solid fa-crown fs-4"></i>
        <div>
          <h6 class="mb-0">
            Piano: <strong>{{ current_user.subscription_plan|capitalize }}</strong>
            {% if current_user.is_in_trial() %}
              <span class="badge bg-warning text-dark">Trial</span>
            {% endif %}
          </h6>
          <small class="text-muted">
            {% if current_user.is_in_trial() %}
              Trial termina tra {{ current_user.get_days_until_renewal() }} giorni
            {% else %}
              {% if current_user.subscription_plan == 'starter' %}
                Piano Starter - Max 5 asset monitorabili
              {% else %}
                Rinnovo tra {{ current_user.get_days_until_renewal() }} giorni
              {% endif %}
            {% endif %}
          </small>
        </div>
      </div>
      
      {% if current_user.subscription_plan == 'starter' %}
      <a href="/pricing" class="btn btn-success">
        <i class="fa-solid fa-rocket"></i> Upgrade a Professional
      </a>
      {% endif %}
    </div>

    <!-- SELETTORE SIMBOLI -->
    <div id="symbolSelector" class="symbol-selector">
      <div class="loading">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2">Caricamento simboli...</p>
      </div>
    </div>

    <!-- INFO AUTO-UPDATE -->
    {% if current_user.is_authenticated and not current_user.is_admin %}
    <div class="alert alert-light d-flex align-items-start gap-3 mb-4" style="border-left:4px solid #667eea;">
      <i class="fa-solid fa-circle-info text-primary fs-5"></i>
      <div>
        <h6 class="mb-1"><strong>Dati Aggiornati Automaticamente</strong></h6>
        <p class="mb-0 small text-muted">
          Il sistema aggiorna automaticamente le analisi ogni <strong>Martedì alle 21:00</strong>.
          Visualizzi sempre i dati più recenti!
        </p>
      </div>
    </div>
    {% endif %}

    <!-- TABS -->
    <ul class="nav nav-tabs nav-tabs-custom mb-4" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
          <i class="fa-solid fa-chart-pie me-1"></i> Panoramica
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab">
          <i class="fa-solid fa-chart-line me-1"></i> Grafici COT
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technical" type="button" role="tab">
          <i class="fa-solid fa-chart-area me-1"></i> Analisi Tecnica
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="economic-tab" data-bs-toggle="tab" data-bs-target="#economic" type="button" role="tab">
          <i class="fa-solid fa-globe me-1"></i> Dati Economici
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="predictions-tab" data-bs-toggle="tab" data-bs-target="#predictions" type="button" role="tab">
          <i class="fa-solid fa-wand-magic-sparkles me-1"></i> Previsioni
        </button>
      </li>
    </ul>

    <!-- CONTENT -->
    <div class="tab-content" id="mainTabsContent">
      <!-- Panoramica -->
      <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row g-3 mb-4">
          <div class="col-12 col-md-3">
            <div class="card-enhanced">
              <h6 class="text-muted">Net Position</h6>
              <div class="d-flex align-items-end gap-2">
                <h3 id="netPosition" class="mb-0">—</h3>
                <small id="netChange" class="fw-bold"></small>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <div class="card-enhanced">
              <h6 class="text-muted">Sentiment Score</h6>
              <h3 id="sentimentScore" class="mb-2">—</h3>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <div class="card-enhanced">
              <h6 class="text-muted">Previsione AI</h6>
              <div id="aiPrediction">
                <span class="signal-box signal-neutral">IN ATTESA</span>
              </div>
              <small class="text-muted d-block mt-2">Confidenza: <span id="confidence">—</span>%</small>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <div class="card-enhanced">
              <h6 class="text-muted">Ultimo Aggiornamento</h6>
              <h3 id="lastUpdate" class="mb-1">—</h3>
              <small class="text-muted">Sistema attivo</small>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-6">
            <div class="card-enhanced">
              <h5 class="mb-3"><i class="fa-solid fa-tachometer-alt text-primary me-2"></i>Analisi Rapida</h5>
              <div id="quickAnalysis">
                <div class="loading">Seleziona un simbolo per vedere l'analisi rapida</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card-enhanced">
              <h5 class="mb-3"><i class="fa-solid fa-triangle-exclamation text-warning me-2"></i>Alert e Notifiche</h5>
              <div id="alertsPanel">
                <div class="text-muted">Nessun alert attivo</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grafici COT -->
      <div class="tab-pane fade" id="charts" role="tabpanel">
        <div class="card-enhanced mb-4">
          <h5 class="mb-3">Posizioni COT · Trend Storico</h5>
          <div class="chart-wrap"><canvas id="cotChart"></canvas></div>
        </div>
      </div>

      <!-- Analisi Tecnica -->
      <div class="tab-pane fade" id="technical" role="tabpanel">
        <div class="card-enhanced">
          <h5 class="mb-3">Analisi Tecnica</h5>
          <div id="technicalAnalysis">
            <div class="loading">Caricamento analisi tecnica...</div>
          </div>
        </div>
      </div>

      <!-- Dati Economici -->
      <div class="tab-pane fade" id="economic" role="tabpanel">
        <div class="card-enhanced">
          <h5 class="mb-3">Indicatori Economici</h5>
          <div id="economicIndicators">
            <div class="loading">Caricamento dati economici...</div>
          </div>
        </div>
      </div>

      <!-- Previsioni -->
      <div class="tab-pane fade" id="predictions" role="tabpanel">
        <div class="card-enhanced mb-4">
          <h5 class="mb-3">Analisi GPT</h5>
          <div id="gptAnalysis" class="p-3 bg-light rounded">
            <div class="loading">
              <p class="mb-0">Seleziona un simbolo e clicca "Analisi AI" per generare previsioni.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
  // VARIABILI GLOBALI
  let currentSymbol = null;
  let cotChart = null;

  // INIT
  document.addEventListener('DOMContentLoaded', function() {
    loadSymbols();
    setupEventListeners();
  });

  // CARICA SIMBOLI
  function loadSymbols() {
    fetch('/api/symbols')
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('symbolSelector');
        
        if (!data.symbols || data.symbols.length === 0) {
          container.innerHTML = '<div class="alert alert-danger">Nessun simbolo disponibile</div>';
          return;
        }
        
        let html = '';
        data.symbols.forEach(symbol => {
          const code = symbol.code || symbol;
          const name = symbol.name || symbol;
          html += `
            <button class="symbol-btn" data-symbol="${code}" onclick="selectSymbol('${code}')">
              ${name}
            </button>
          `;
        });
        
        container.innerHTML = html;
        
        // Mostra info limite piano
        if (data.limit && data.limit > 0) {
          const alert = document.createElement('div');
          alert.className = 'alert alert-warning mb-3';
          alert.innerHTML = `<i class="fas fa-info-circle"></i> ${data.message || 'Piano Starter: max ' + data.limit + ' asset'}`;
          container.parentElement.insertBefore(alert, container);
        }
        
        // Seleziona primo simbolo
        if (data.symbols[0]) {
          selectSymbol(data.symbols[0].code || data.symbols[0]);
        }
      })
      .catch(err => {
        console.error('Errore caricamento simboli:', err);
        document.getElementById('symbolSelector').innerHTML = 
          '<div class="alert alert-danger">Errore nel caricamento dei simboli</div>';
      });
  }

  // SELEZIONA SIMBOLO
  function selectSymbol(symbol) {
    currentSymbol = symbol;
    console.log('Simbolo selezionato:', symbol);
    
    // Evidenzia pulsante
    document.querySelectorAll('.symbol-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.symbol === symbol) {
        btn.classList.add('active');
      }
    });
    
    // Carica dati
    loadSymbolData(symbol);
  }

  // CARICA DATI SIMBOLO
  function loadSymbolData(symbol) {
    // Fetch dati COT
    fetch(`/api/data/${symbol}?days=30`)
      .then(res => res.json())
      .then(data => {
        if (data && data.length > 0) {
          updateOverview(data[0]);
          updateChart(data);
        }
      })
      .catch(err => console.error('Errore caricamento dati:', err));
  }

  // AGGIORNA OVERVIEW
  function updateOverview(data) {
    document.getElementById('netPosition').textContent = data.net_position || '—';
    document.getElementById('sentimentScore').textContent = 
      data.sentiment_score ? data.sentiment_score.toFixed(2) + '%' : '—';
    document.getElementById('lastUpdate').textContent = 
      data.date ? new Date(data.date).toLocaleDateString('it-IT') : '—';
  }

  // AGGIORNA GRAFICO
  function updateChart(data) {
    const ctx = document.getElementById('cotChart');
    if (!ctx) return;
    
    // Distruggi grafico esistente
    if (cotChart) {
      cotChart.destroy();
    }
    
    // Dati per il grafico
    const labels = data.map(d => new Date(d.date).toLocaleDateString('it-IT')).reverse();
    const netPositions = data.map(d => d.net_position).reverse();
    
    // Crea nuovo grafico
    cotChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Net Position',
          data: netPositions,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.1)',
          borderWidth: 2,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true
          }
        },
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  }

  // EVENT LISTENERS
  function setupEventListeners() {
    // Pulsante Refresh
    const btnRefresh = document.getElementById('btnRefresh');
    if (btnRefresh) {
      btnRefresh.addEventListener('click', () => {
        if (currentSymbol) {
          loadSymbolData(currentSymbol);
        }
      });
    }
    
    // Pulsante Analisi AI
    const btnRun = document.getElementById('btnRun');
    if (btnRun) {
      btnRun.addEventListener('click', runAIAnalysis);
    }
  }

  // ANALISI AI
  function runAIAnalysis() {
    if (!currentSymbol) {
      alert('Seleziona prima un simbolo');
      return;
    }
    
    const gptDiv = document.getElementById('gptAnalysis');
    gptDiv.innerHTML = '<div class="loading"><div class="spinner-border text-primary"></div><p class="mt-3">Analisi AI in corso...</p></div>';
    
    // Cambia tab a Previsioni
    const predictionsTab = document.getElementById('predictions-tab');
    if (predictionsTab) {
      predictionsTab.click();
    }
    
    fetch(`/api/scrape/${currentSymbol}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          gptDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
          gptDiv.innerHTML = `
            <div class="gpt-premium">
              <h4 class="mb-3">Analisi Completata!</h4>
              <p>Simbolo: <strong>${currentSymbol}</strong></p>
              <p class="mb-0">${data.message || 'Dati aggiornati con successo'}</p>
            </div>
          `;
          
          // Ricarica dati
          loadSymbolData(currentSymbol);
        }
      })
      .catch(err => {
        console.error('Errore analisi AI:', err);
        gptDiv.innerHTML = '<div class="alert alert-danger">Errore durante l\'analisi AI</div>';
      });
  }
  </script>
  
  <script src="{{ url_for('static', filename='js/dashboard-enhanced.js') }}" charset="utf-8"></script>
</body>
</html>